<!DOCTYPE html>
<html>
<head>
  <title>Pitch</title>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.min.js"></script>
  <script type="text/javascript">
    const initFreq = 440;

    let csound = null;

    const synthCode = `

sr = 44100
ksmps = 64
nchnls = 2
0dbfs = 1

gifone ftgen 1, 0, 16384, 10, 1.000000, 0.000000, 0.000000, 0.031250, 0.000000, 0.011340, 0.000000, 0.000000, 0.004115, 0.000000, 0.000000, 0.002005, 0.000000, 0.001364, 0.000000, 0.000000, 0.000839, 0.000000, 0.000000, 0.000559, 0.000000, 0.000440, 0.000000, 0.000000, 0.000320, 0.000000, 0.000000, 0.000241, 0.000000, 0.000203, 0.000000, 0.000000, 0.000160, 0.000000, 0.000000, 0.000129, 0.000000, 0.000112, 0.000000, 0.000000, 0.000093, 0.000000, 0.000082, 0.000000, 0.000000, 0.000070, 0.000000, 0.000000, 0.000059, 0.000000, 0.000054, 0.000000, 0.000000, 0.000047, 0.000000, 0.000000, 0.000041, 0.000000, 0.000037

giftwo ftgen 2, 0, 16384, 10, 1

instr 1
aSig = (1.0/2.0/sqrt(p5)) * ( oscbnk:a ( p4, 0.3, 2.0, 2.0, p5, 0, 0.2, 0.3, 0.3, 0.4, 128+64+2, 0, 0, 0, 0, 0, 0, -1, 1, 2, 2, 2, 2, 2 ) )
kDamp = ampdb:k ( linseg:k ( -70, 0.1, -10, 1.9, -10, 28, -70 ) )
outall kDamp * aSig
endin

`;
  </script>
  <style>
    body {
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: sans-serif;
      background-color: color-mix(in srgb, black 75%, grey 25%);
    }
    #equation {
      font-size: 2em;
      color: lightgrey;
    }
  </style>
</head>
<body>
  <div id="equation"></div>
  <script>
    let freq = initFreq;
    let ctr2 = 0, ctr3 = 0, ctr5 = 0, ctr7 = 0, ctr11 = 0;
    function playSound() {
      csound.inputMessage(`i 1 0 30 ${freq.toFixed(2)} 4`);
    }
    function updateEquation() {
      fact = ""
      if (ctr3 != 0) {
        if (fact != "") fact += " \\cdot ";
        fact += "{ \\color{salmon} 3";
        if (ctr3 != 1) fact += `^{${ctr3}}`;
        fact += " } "
      }
      if (ctr5 != 0) {
        if (fact != "") fact += " \\cdot ";
        fact += "{ \\color{lightgreen} 5";
        if (ctr5 != 1) fact += `^{${ctr5}}`;
        fact += " } "
      }
      if (ctr7 != 0) {
        if (fact != "") fact += " \\cdot ";
        fact += "{ \\color{mediumpurple} 7";
        if (ctr7 != 1) fact += `^{${ctr7}}`;
        fact += " } "
      }
      if (ctr11 != 0) {
        if (fact != "") fact += " \\cdot ";
        fact += "{ \\color{khaki} 11";
        if (ctr11 != 1) fact += `^{${ctr11}}`;
        fact += " } "
      }
      if (ctr2 != 0) {
        if (fact != "") fact += " \\cdot ";
        fact += "{ \\color{grey} 2";
        if (ctr2 != 1) fact += `^{${ctr2}}`;
        fact += " } "
      }
      if (fact == "")
        fact += "1";
      eq = `$$ \\frac{${freq.toFixed(2)}}{${initFreq.toFixed(0)}} = ${fact} $$`;
      document.getElementById("equation").innerHTML = eq;
      MathJax.typesetPromise();
    }
    updateEquation();
    document.addEventListener("keydown", async (event) => {
      if (csound == null) {
        const { Csound } = await import("https://cdn.jsdelivr.net/npm/@csound/browser@6.18.7/+esm");
        csound = await Csound();
        await csound.setOption("-odac");
        await csound.compileOrc(synthCode);
        await csound.start();
      }
      if (event.key == "g") {
        freq *= 2.0/1.0;
        ctr2 += 1;
      }
      else if (event.key == "h") {
        freq *= 1.0/2.0;
        ctr2 -= 1;
      }
      else if (event.key == "f") {
        freq *= 3.0/2.0;
        ctr3 += 1; ctr2 -=1 ;
      }
      else if (event.key == "j") {
        freq *= 2.0/3.0;
        ctr3 -= 1; ctr2 += 1;
      }
      else if (event.key == "d") {
        freq *= 5.0/4.0;
        ctr5 += 1; ctr2 -= 2;
      }
      else if (event.key == "k") {
        freq *= 4.0/5.0;
        ctr5 -= 1; ctr2 += 2;
      }
      else if (event.key == "s") {
        freq *= 7.0/4.0;
        ctr7 += 1; ctr2 -= 2;
      }
      else if (event.key == "l") {
        freq *= 4.0/7.0;
        ctr7 -= 1; ctr2 += 2;
      }
      else if (event.key == "a") {
        freq *= 11.0/8.0;
        ctr11 += 1; ctr2 -= 3;
      }
      else if (event.key == ";") {
        freq *= 8.0/11.0;
        ctr11 -= 1; ctr2 += 3;
      }
      playSound();
      updateEquation();
    });
  </script>
  </body>
</html>
